<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Tutorials on aptly - Debian repository management tool</title><generator uri="https://hugo.spf13.com">Hugo</generator><link>http://aptly-dev.github.io/www.aptly.info/tutorial/</link><language>en-us</language><author>Andrey Smirnov</author><updated>Fri, 10 Oct 2014 23:30:00 UTC</updated><item><title>Managing repositories of your packages</title><link>http://aptly-dev.github.io/www.aptly.info/tutorial/repo/</link><pubDate>Fri, 10 Oct 2014 23:30:00 UTC</pubDate><author>Andrey Smirnov</author><guid>http://aptly-dev.github.io/www.aptly.info/tutorial/repo/</guid><description>&lt;h2 id="managing-repositories-of-your-packages">Managing repositories of your packages&lt;/h2>
&lt;p class="lead">Goal: create repository with your own software as .deb packages,
publish it to Amazon S3, handle updates.&lt;/p>
&lt;p>In this tutorial I would describe how do I manage &lt;em>aptly&lt;/em> releases in repo.aptly.info repository using &lt;em>aptly&lt;/em> itself.&lt;/p>
&lt;h3 id="adding-packages-and-creating-snapshots">Adding packages and creating snapshots&lt;/h3>
&lt;p>First, I create local repository that would hold all released versions of aptly:&lt;/p>
&lt;pre class="code">
$ aptly repo create -distribution=squeeze -component=main aptly-release
Local repo [aptly-release] successfully added.
You can run 'aptly repo add aptly-release ...' to add packages to repository.
&lt;/pre>
&lt;p>While creating repository I&amp;rsquo;ve specified distribution and component names, that would be used
when I publish packages from this repository.&lt;/p>
&lt;p>As new versions of aptly are released, I add new &lt;code>.deb&lt;/code> packages by simply pointing aptly
to the directory with files:&lt;/p>
&lt;pre class="code">
$ aptly repo add aptly-release debs
Loading packages...
[+] aptly_0.8_amd64 added
[+] aptly_0.8_i386 added
&lt;/pre>
&lt;p>The repository holds all versions of aptly released so far:&lt;/p>
&lt;pre class="code">
$ aptly repo show -with-packages aptly-release
Name: aptly-release
Comment:
Default Distribution: squeeze
Default Component: main
Number of packages: 14
Packages:
aptly_0.4.1_amd64
aptly_0.5_amd64
aptly_0.5.1_amd64
aptly_0.6_amd64
aptly_0.7_amd64
aptly_0.7.1_amd64
aptly_0.8_amd64
aptly_0.4.1_i386
aptly_0.5_i386
aptly_0.5.1_i386
aptly_0.6_i386
aptly_0.7_i386
aptly_0.7.1_i386
aptly_0.8_i386
&lt;/pre>
&lt;p>After each major release, I create snapshot of local repository, so that I can &amp;ldquo;get back in time&amp;rdquo; to old
state of repository:&lt;/p>
&lt;pre class="code">
$ aptly snapshot create aptly-0.8 from repo aptly-release
Snapshot aptly-0.8 successfully created.
You can run 'aptly publish snapshot aptly-0.8' to publish snapshot as Debian repository.
$ aptly snapshot list
List of snapshots:
* [aptly-0.4.1]: Snapshot from local repo [aptly-release]
* [aptly-0.5]: Snapshot from local repo [aptly-release]
* [aptly-0.5.1]: Snapshot from local repo [aptly-release]
* [aptly-0.6]: Snapshot from local repo [aptly-release]
* [aptly-0.7]: Snapshot from local repo [aptly-release]
* [aptly-0.7.1]: Snapshot from local repo [aptly-release]
* [aptly-0.8]: Snapshot from local repo [aptly-release]
To get more information about snapshot, run `aptly snapshot show &lt;name>`.
&lt;/pre>
&lt;h3 id="publishing-to-amazon-s3">Publishing to Amazon S3&lt;/h3>
&lt;p>I&amp;rsquo;ve chosen to Amazon S3 to host aptly package repository, as it is the easiest way to get reliable HTTP
hosting for static files.&lt;/p>
&lt;p>First, I&amp;rsquo;ve created S3 bucket &lt;code>repo.aptly.info&lt;/code> (name should match future domain name) using Amazon console, and
enabled website hosting. To the root of the bucket I&amp;rsquo;ve uploaded manually file &lt;code>index.html&lt;/code> with
some &lt;a href="http://repo.aptly.info/">introductory notes&lt;/a>.&lt;/p>
&lt;p>Next, for security reasons it&amp;rsquo;s best to create separate user via Amazon IAM console that would do uploads
from aptly to S3. Save security credentials for the user into handy bash script &lt;code>.aws.sh&lt;/code>:&lt;/p>
&lt;pre>&lt;code>export AWS_SECRET_ACCESS_KEY=&amp;quot;XXXXXXXXXXXXXXXXXXX&amp;quot;
export AWS_ACCESS_KEY_ID=&amp;quot;YYYYYYYYYYYYYYYYYYYY&amp;quot;
&lt;/code>&lt;/pre>
&lt;p>And source this script in before performing any S3 operations from aptly:&lt;/p>
&lt;pre class="code">
$ . .aws.sh
&lt;/pre>
&lt;p>For the user created, apply custom security policy:&lt;/p>
&lt;pre>&lt;code>{
&amp;quot;Version&amp;quot;: &amp;quot;2012-10-17&amp;quot;,
&amp;quot;Statement&amp;quot;: [
{
&amp;quot;Sid&amp;quot;: &amp;quot;Stmt1405592139000&amp;quot;,
&amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;,
&amp;quot;Action&amp;quot;: [
&amp;quot;s3:DeleteObject&amp;quot;,
&amp;quot;s3:GetObject&amp;quot;,
&amp;quot;s3:ListBucket&amp;quot;,
&amp;quot;s3:PutObject&amp;quot;,
&amp;quot;s3:PutObjectAcl&amp;quot;
],
&amp;quot;Resource&amp;quot;: [
&amp;quot;arn:aws:s3:::repo.aptly.info/*&amp;quot;, &amp;quot;arn:aws:s3:::repo.aptly.info&amp;quot;
]
}
]
}
&lt;/code>&lt;/pre>
&lt;p>You would need to change &lt;code>repo.aptly.info&lt;/code> to the name of your S3 bucket. This policy allows limited
number of operations only on one bucket, which should be pretty safe.&lt;/p>
&lt;p>Final piece: setup your DNS name to point to S3, more information in &lt;a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html">Amazon S3 docs&lt;/a>.&lt;/p>
&lt;p>So the only thing left is to setup aptly to use that S3 bucket for publishing. I edit &lt;code>~/.aptly.conf&lt;/code>:&lt;/p>
&lt;pre>&lt;code>{
&amp;quot;architectures&amp;quot;:[],
....
&amp;quot;S3PublishEndpoints&amp;quot;:{
&amp;quot;repo.aptly.info&amp;quot;:{
&amp;quot;region&amp;quot;:&amp;quot;us-east-1&amp;quot;,
&amp;quot;bucket&amp;quot;:&amp;quot;repo.aptly.info&amp;quot;,
&amp;quot;acl&amp;quot;:&amp;quot;public-read&amp;quot;
}
}
}
&lt;/code>&lt;/pre>
&lt;p>In &lt;code>S3PublishEndpoints&lt;/code> section I add new entry &lt;code>repo.aptly.info&lt;/code> with bucket name, region (you choose region when creating the bucket) and &lt;code>public-read&lt;/code> acl. By default aptly publishes files with &lt;code>private&lt;/code> acl which doesn&amp;rsquo;t work for me, as I&amp;rsquo;m
creating public repo.&lt;/p>
&lt;p>So now I can publish to S3 with aptly. I&amp;rsquo;m publishing latest snapshot, &lt;code>aptly-0.8&lt;/code>. I could have published repository &lt;code>aptly-release&lt;/code> directly, but doing via snapshot gives more flexibility: I can rollback to previous snapshot if things go wrong
for any reason.&lt;/p>
&lt;pre class="code">
$ aptly publish snapshot aptly-0.8 s3:repo.aptly.info:
...
&lt;/pre>
&lt;p>aptly would upload package files to my S3 bucket, generate index files, do signing and so on. In the end &lt;code>repo.aptly.info&lt;/code>
holds complete Debian repository structure, and I can use it in apt sources:&lt;/p>
&lt;pre>&lt;code>deb http://repo.aptly.info/ squeeze main
&lt;/code>&lt;/pre>
&lt;p>When next of aptly would be released, I would add new package to &lt;code>aptly-release&lt;/code> local repo, create snapshot &lt;code>aptly-0.9&lt;/code> and
switch S3 published repository to new version with following command:&lt;/p>
&lt;pre class="code">
$ aptly publish switch squeeze s3:repo.aptly.info: aptly-0.9
...
&lt;/pre>
&lt;p>Published repositories are referenced by distribution name (&lt;code>squeeze&lt;/code> in our case, taken from local repo defaults) and
prefix which includes storage engine (&lt;code>s3:repo.aptly.info:&lt;/code>).&lt;/p></description></item><item><title>Pulling new versions of packages</title><link>http://aptly-dev.github.io/www.aptly.info/tutorial/pull/</link><pubDate>Fri, 10 Oct 2014 23:20:00 UTC</pubDate><author>Andrey Smirnov</author><guid>http://aptly-dev.github.io/www.aptly.info/tutorial/pull/</guid><description>&lt;h2 id="pulling-new-versions-of-packages">Pulling new versions of packages&lt;/h2>
&lt;p class="lead">Goal: pull new version of nginx package from backports, add aptly
package from 3rd party repository.&lt;/p>
&lt;p>Let&amp;rsquo;s start with mirrors created in &lt;a href="http://aptly-dev.github.io/www.aptly.info/tutorial/mirror/">first tutorial&lt;/a>: &lt;code>wheezy-main&lt;/code>,
&lt;code>wheezy-updates&lt;/code> and &lt;code>wheezy-security&lt;/code>.&lt;/p>
&lt;h3 id="backporting-nginx">Backporting nginx&lt;/h3>
&lt;p>Create new mirror &lt;code>wheezy-backports&lt;/code>:&lt;/p>
&lt;pre class="code">
$ aptly mirror create -architectures=amd64 -filter=nginx -filter-with-deps wheezy-backports http://ftp.ru.debian.org/debian/ wheezy-backports main
...
$ aptly mirror update wheezy-backports
Downloading http://ftp.ru.debian.org/debian/dists/wheezy-backports/InRelease...
gpgv: Signature made Thu 09 Oct 2014 02:49:29 PM UTC using RSA key ID 46925553
gpgv: Good signature from "Debian Archive Automatic Signing Key (7.0/wheezy) &amp;lt;ftpmaster@debian.org&amp;gt;"
Downloading &amp;amp; parsing package files...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy-backports/main/binary-amd64/Packages.bz2...
Applying filter...
Packages filtered: 3290 -> 10.
Building download queue...
Download queue: 10 items (2.45 MiB)
Downloading http://ftp.ru.debian.org/debian/pool/main/l/luajit/libluajit-5.1-2_2.0.3+dfsg-3~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-full_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-extras_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-common_1.6.2-1~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/l/luajit/libluajit-5.1-common_2.0.3+dfsg-3~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-naxsi_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-light_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/i/init-system-helpers/init-system-helpers_1.18~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/g/geoip/libgeoip1_1.5.0-3~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx_1.6.2-1~bpo70+1_all.deb...
Mirror `wheezy-backports` has been successfully updated.
&lt;/pre>
&lt;p>Once again, I&amp;rsquo;ve been using filters to reduce download size, but I could&amp;rsquo;ve create mirror without filter
covering whole wheezy-backports repostiroy.&lt;/p>
&lt;p>Create snapshot of that mirror:&lt;/p>
&lt;pre class="code">
$ aptly snapshot create wheezy-backports-20141009 from mirror wheezy-backports
Snapshot wheezy-backports-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-backports-20141009' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>The magic happens when I ask aptly to pull new version of &lt;code>nginx&lt;/code> package from &lt;code>wheezy-backports&lt;/code> snapshot
into my &lt;code>wheezy-main&lt;/code> snapshot:&lt;/p>
&lt;pre class="code">
$ aptly snapshot pull wheezy-final-20141009 wheezy-backports-20141009 wheezy-main-nginx-20141009 nginx
Dependencies would be pulled into snapshot:
[wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'
from snapshot:
[wheezy-backports-20141009]: Snapshot from mirror [wheezy-backports]: http://ftp.ru.debian.org/debian/ wheezy-backports
and result would be saved as new snapshot wheezy-main-nginx-20141009.
Loading packages (327)...
Building indexes...
[+] init-system-helpers_1.18~bpo70+1_all added
[+] libluajit-5.1-2_2.0.3+dfsg-3~bpo70+1_amd64 added
[+] libluajit-5.1-common_2.0.3+dfsg-3~bpo70+1_all added
[-] nginx-naxsi-ui_1.2.1-2.2+wheezy3_all removed
[-] nginx_1.2.1-2.2+wheezy3_all removed
[+] nginx_1.6.2-1~bpo70+1_all added
[-] nginx-common_1.2.1-2.2+wheezy3_all removed
[+] nginx-common_1.6.2-1~bpo70+1_all added
[-] nginx-extras_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-extras_1.6.2-1~bpo70+1_amd64 added
[-] nginx-full_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-full_1.6.2-1~bpo70+1_amd64 added
[-] nginx-light_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-light_1.6.2-1~bpo70+1_amd64 added
[-] nginx-naxsi_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-naxsi_1.6.2-1~bpo70+1_amd64 added
Snapshot wheezy-main-nginx-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-main-nginx-20141009' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>As you can see, aptly has replaced not only &lt;code>nginx&lt;/code> package, but all its dependencies that required upgrade.
Now snapshot &lt;code>wheezy-main-nginx-20141009&lt;/code> is Debian wheezy 7.6 plus new version of nginx.&lt;/p>
&lt;h3 id="pulling-aptly">Pulling aptly&lt;/h3>
&lt;p>In order to add latest version of aptly package from &lt;code>repo.aptly.info&lt;/code> mirror, create
and update mirror:&lt;/p>
&lt;pre class="code">
$ aptly mirror create aptly-repo http://repo.aptly.info/ squeeze
Downloading http://repo.aptly.info/dists/squeeze/InRelease...
gpgv: Signature made Fri 03 Oct 2014 02:35:18 PM UTC using RSA key ID 2A194991
gpgv: Good signature from "Andrey Smirnov &amp;lt;me@smira.ru&amp;gt;"
Mirror [aptly-repo]: http://repo.aptly.info/ squeeze successfully added.
You can run 'aptly mirror update aptly-repo' to download repository contents.
$ aptly mirror update aptly-repo
Downloading http://repo.aptly.info/dists/squeeze/InRelease...
gpgv: Signature made Fri 03 Oct 2014 02:35:18 PM UTC using RSA key ID 2A194991
gpgv: Good signature from "Andrey Smirnov &amp;lt;me@smira.ru&amp;gt;"
Downloading &amp;amp; parsing package files...
Downloading http://repo.aptly.info/dists/squeeze/main/binary-amd64/Packages.bz2...
Downloading http://repo.aptly.info/dists/squeeze/main/binary-i386/Packages.bz2...
Building download queue...
Download queue: 14 items (47.29 MiB)
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.6_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.6_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7.1_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.4.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.4.1_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.8_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.8_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5.1_i386.deb...
Mirror `aptly-repo` has been successfully updated.
&lt;/pre>
&lt;p>In this case I haven&amp;rsquo;t limited architectures (so both &lt;code>i386&lt;/code> and &lt;code>amd64&lt;/code> were downloaded) and haven&amp;rsquo;t specified
component name: aptly can figure it out on its own.&lt;/p>
&lt;p>Next, create snapshot:&lt;/p>
&lt;pre class="code">
$ aptly snapshot create aptly-0.8 from mirror aptly-repo
Snapshot aptly-0.8 successfully created.
You can run 'aptly publish snapshot aptly-0.8' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>And pull latest version of aptly from that snapshot into my &lt;code>wheezy-main-nginx-20141009&lt;/code> snapshot created
in previous section:&lt;/p>
&lt;pre class="code">
$ aptly snapshot pull wheezy-main-nginx-20141009 aptly-0.8 wheezy-main-nginx-aptly-20141009 aptly
Dependencies would be pulled into snapshot:
[wheezy-main-nginx-20141009]: Pulled into 'wheezy-main-7.6' with 'wheezy-backports-20141009' as source, pull request was: 'nginx'
from snapshot:
[aptly-0.8]: Snapshot from mirror [aptly-repo]: http://repo.aptly.info/ squeeze
and result would be saved as new snapshot wheezy-main-nginx-aptly-20141009.
Loading packages (331)...
Building indexes...
[+] aptly_0.8_amd64 added
Snapshot wheezy-main-nginx-aptly-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-main-nginx-aptly-20141009' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>I haven&amp;rsquo;t specified version: aptly would choose latest version by default, also aptly is smart enough
to pull only &lt;code>amd64&lt;/code> package, as my snapshot &lt;code>wheezy-main-nginx-20141009&lt;/code> contains only &lt;code>amd64&lt;/code> packages.&lt;/p>
&lt;h3 id="publishing">Publishing&lt;/h3>
&lt;p>So we&amp;rsquo;re ready to publish new snapshot as Debian repository. This time I would use two prefixes: one for stable
version of repository, which is well-tested, and another one for &amp;ldquo;testing&amp;rdquo; version that I would like to test
on small set of machines before deploying it fully.&lt;/p>
&lt;p>Publishing vanilla wheezy distribution from &lt;a href="http://aptly-dev.github.io/www.aptly.info/tutorial/mirror/">mirroring tutorial&lt;/a> as stable version:&lt;/p>
&lt;pre class="code">
$ aptly publish snapshot -distribution=wheezy wheezy-final-20141009 stable
...
Snapshot wheezy-final-20141009 has been successfully published.
Please setup your webserver to serve directory '/home/smira/.aptly/public' with autoindexing.
Now you can add following line to apt sources:
deb http://your-server/stable/ wheezy main
Don't forget to add your GPG key to apt with apt-key.
You can also use `aptly serve` to publish your repositories over HTTP quickly.
&lt;/pre>
&lt;p>I&amp;rsquo;ve added one more argument on the command line, &lt;code>stable&lt;/code> which is publishing prefix (simply
subdirectory to publish under). Now the apt-sources line suggested by aptly contains
that prefix: &lt;code>deb http://your-server/stable/ wheezy main&lt;/code>.&lt;/p>
&lt;p>And I publish my wheezy + new nginx + aptly repository as testing version:&lt;/p>
&lt;pre class="code">
$ aptly publish snapshot -distribution=wheezy wheezy-main-nginx-aptly-20141009 testing
...
Snapshot wheezy-main-nginx-aptly-20141009 has been successfully published.
Please setup your webserver to serve directory '/home/smira/.aptly/public' with autoindexing.
Now you can add following line to apt sources:
deb http://your-server/testing/ wheezy main
Don't forget to add your GPG key to apt with apt-key.
You can also use `aptly serve` to publish your repositories over HTTP quickly.
&lt;/pre>
&lt;p>I can verify that I have two published repos in different prefixes:&lt;/p>
&lt;pre class="code">
$ aptly serve
Serving published repositories, recommended apt sources list:
# stable/wheezy [amd64] publishes {main: [wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'}
deb http://debian:8080/stable/ wheezy main
# testing/wheezy [amd64] publishes {main: [wheezy-main-nginx-aptly-20141009]: Pulled into 'wheezy-main-nginx-20141009' with 'aptly-0.8' as source, pull request was: 'aptly'}
deb http://debian:8080/testing/ wheezy main
&lt;/pre>
&lt;p>After successful round of testing, I can use &lt;code>aptly publish switch&lt;/code> to switch by stable published repository
to the new snapshot &lt;code>wheezy-main-nginx-aptly-20141009&lt;/code> and update my target machines.&lt;/p>
&lt;p>If I generate the graph, it would look like that:&lt;/p>
&lt;img class="img-responsive" src="../../img/aptly-graph3.png"></description></item><item><title>Mirroring with snapshots</title><link>http://aptly-dev.github.io/www.aptly.info/tutorial/mirror/</link><pubDate>Thu, 09 Oct 2014 23:20:00 UTC</pubDate><author>Andrey Smirnov</author><guid>http://aptly-dev.github.io/www.aptly.info/tutorial/mirror/</guid><description>&lt;h2 id="mirroring-with-snapshots">Mirroring with snapshots&lt;/h2>
&lt;p class="lead">Goal: build mirror of Debian wheezy, with security updates incorporated,
done using snapshots to make package installation consistent on all the hosts.&lt;/p>
&lt;h3 id="preparation">Preparation&lt;/h3>
&lt;p>First, &lt;a href="http://aptly-dev.github.io/www.aptly.info/download/">install&lt;/a> aptly. Please verify that you have aptly
dependencies installed: packages &lt;code>bzip2&lt;/code>, &lt;code>gnupg&lt;/code> and &lt;code>gpgv&lt;/code>.
Second, choose some user that would
be running all aptly commands (it shouldn&amp;rsquo;t be root user).&lt;/p>
&lt;p>We would be signing published repositories with our GPG key, so if you don&amp;rsquo;t
have GPG key yet, it&amp;rsquo;s time to create one:&lt;/p>
&lt;pre class="code">
$ gpg --gen-key
gpg (GnuPG) 1.4.12; Copyright (C) 2012 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Please select what kind of key you want:
(1) RSA and RSA (default)
(2) DSA and Elgamal
(3) DSA (sign only)
(4) RSA (sign only)
Your selection?
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048)
Requested keysize is 2048 bits
Please specify how long the key should be valid.
0 = key does not expire
&lt;n> = key expires in n days
&lt;n>w = key expires in n weeks
&lt;n>m = key expires in n months
&lt;n>y = key expires in n years
Key is valid for? (0)
Key does not expire at all
Is this correct? (y/N) y
You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
"Heinrich Heine (Der Dichter) &amp;lt;heinrichh@duesseldorf.de&amp;gt;"
Real name: Andrey Smirnov
Email address: me@smira.ru
Comment: Signing repos
You selected this USER-ID:
"Andrey Smirnov (Signing repos) &amp;lt;me@smira.ru&amp;gt;"
Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
You need a Passphrase to protect your secret key.
gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0 valid: 1 signed: 0 trust: 0-, 0q, 0n, 0m, 0f, 1u
pub 2048R/6430156A 2014-10-09
Key fingerprint = 52EC DF0E EE8B 5DDF CC8F 7038 B9C8 F8B4 6430 156A
uid Andrey Smirnov (Signing repos) &amp;lt;me@smira.ru&amp;gt;
sub 2048R/E0C10001 2014-10-09
&lt;/pre>
&lt;p>Default options should be fine, you need to backup your key and prepare revocation
certificate, for example like described &lt;a href="http://fedoraproject.org/wiki/Creating_GPG_Keys">here&lt;/a>.&lt;/p>
&lt;p>Now we&amp;rsquo;re ready to start!&lt;/p>
&lt;h3 id="creating-mirrors">Creating Mirrors&lt;/h3>
&lt;p>Let&amp;rsquo;s assume that we need to mirror &lt;code>wheezy&lt;/code> (current stable) Debian distribution for architecture &lt;code>amd64&lt;/code>,
Only &lt;code>main&lt;/code> component is required and this repository is targeted for servers, not desktops.
Choose one of the Debian servers to download packages from the
&lt;a href="https://www.debian.org/mirror/list">official list&lt;/a>. Let it be &lt;code>ftp.ru.debian.org&lt;/code> in this tutorial.&lt;/p>
&lt;p>Create first mirror for &lt;code>main&lt;/code> component:&lt;/p>
&lt;pre class="code">
$ aptly mirror create -architectures=amd64 -filter='Priority (required) | Priority (important) | Priority (standard)' wheezy-main http://ftp.ru.debian.org/debian/ wheezy main
Looks like your keyring with trusted keys is empty. You might consider importing some keys.
If you're running Debian or Ubuntu, it's a good idea to import current archive keys by running:
gpg --no-default-keyring --keyring /usr/share/keyrings/debian-archive-keyring.gpg --export | gpg --no-default-keyring --keyring trustedkeys.gpg --import
(for Ubuntu, use /usr/share/keyrings/ubuntu-archive-keyring.gpg)
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/InRelease...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release.gpg...
gpgv: Signature made Sat 12 Jul 2014 10:59:56 AM UTC using RSA key ID 46925553
gpgv: Can't check signature: public key not found
gpgv: Signature made Sat 12 Jul 2014 11:04:06 AM UTC using RSA key ID 65FFB764
gpgv: Can't check signature: public key not found
Looks like some keys are missing in your trusted keyring, you may consider importing them from keyserver:
gpg --no-default-keyring --keyring trustedkeys.gpg --keyserver keys.gnupg.net --recv-keys 46925553 65FFB764
Sometimes keys are stored in repository root in file named Release.key, to import such key:
wget -O - https://some.repo/repository/Release.key | gpg --no-default-keyring --keyring trustedkeys.gpg --import
ERROR: unable to fetch mirror: verification of detached signature failed: exit status 2
&lt;/pre>
&lt;p>aptly is complaining about missing keys in our trusted keyring, as it&amp;rsquo;s not possible to verify authencity
of files being downloaded. Let&amp;rsquo;s follow the advice and import default Debian keyring:&lt;/p>
&lt;pre class="code">
$ gpg --no-default-keyring --keyring /usr/share/keyrings/debian-archive-keyring.gpg --export | gpg --no-default-keyring --keyring trustedkeys.gpg --import
gpg: key 6430156A: public key "Andrey Smirnov (Signing repos) &amp;lt;me@smira.ru&amp;gt;" imported
gpg: key 2A194991: public key "Andrey Smirnov &amp;lt;me@smira.ru&amp;gt;" imported
gpg: key B98321F9: public key "Squeeze Stable Release Key &amp;lt;debian-release@lists.debian.org&amp;gt;" imported
gpg: key 473041FA: public key "Debian Archive Automatic Signing Key (6.0/squeeze) &amp;lt;ftpmaster@debian.org&amp;gt;" imported
gpg: key 65FFB764: public key "Wheezy Stable Release Key &amp;lt;debian-release@lists.debian.org&amp;gt;" imported
gpg: key 46925553: public key "Debian Archive Automatic Signing Key (7.0/wheezy) &amp;lt;ftpmaster@debian.org&amp;gt;" imported
gpg: Total number processed: 6
gpg: imported: 6 (RSA: 6)
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0 valid: 1 signed: 0 trust: 0-, 0q, 0n, 0m, 0f, 1u
&lt;/pre>
&lt;p>Now, let&amp;rsquo;s retry the mirror creation procedure:&lt;/p>
&lt;pre class="code">
$ aptly mirror create -architectures=amd64 -filter='Priority (required) | Priority (important) | Priority (standard) | nginx | postgresql | redis-server | memcached | ruby | golang' -filter-with-deps wheezy-main http://ftp.ru.debian.org/debian/ wheezy main
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/InRelease...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release.gpg...
gpgv: Signature made Sat 12 Jul 2014 10:59:56 AM UTC using RSA key ID 46925553
gpgv: Good signature from "Debian Archive Automatic Signing Key (7.0/wheezy) &amp;lt;ftpmaster@debian.org&amp;gt;"
gpgv: Signature made Sat 12 Jul 2014 11:04:06 AM UTC using RSA key ID 65FFB764
gpgv: Good signature from "Wheezy Stable Release Key &amp;lt;debian-release@lists.debian.org&amp;gt;"
Mirror [wheezy-main]: http://ftp.ru.debian.org/debian/ wheezy successfully added.
You can run 'aptly mirror update wheezy-main' to download repository contents.
&lt;/pre>
&lt;p>Now the signature has been verified: files in the mirror are signed with Debian key
(&lt;a href="https://ftp-master.debian.org/keys.html">list of active keys&lt;/a>).&lt;/p>
&lt;p>The flag &lt;code>-filter=&lt;/code> allows us to cut down number of packages to download. First part, &lt;code>Priority (required) | Priority (important) | Priority (standard)&lt;/code> is essential &amp;ldquo;base&amp;rdquo; Debian system, then several (virtual) packages are added that I
need: &lt;code>nginx&lt;/code>, &lt;code>postgresql&lt;/code>, etc. Flag &lt;code>-filter-with-deps&lt;/code> instructs aptly to include dependencies of
matching packages as well. If filter is not specified, all packages would be included in the mirror and that would
require more space and download size would be bigger.&lt;/p>
&lt;p>Create also &lt;code>wheezy-updates&lt;/code> and &lt;code>wheezy-security&lt;/code> mirrors to get important updates:&lt;/p>
&lt;pre class="code">
$ aptly mirror create -architectures=amd64 -filter='Priority (required) | Priority (important) | Priority (standard) | nginx | postgresql | redis-server | memcached | ruby | golang' -filter-with-deps wheezy-updates http://ftp.ru.debian.org/debian/ wheezy-updates main
...
$ aptly mirror create -architectures=amd64 -filter='Priority (required) | Priority (important) | Priority (standard) | nginx | postgresql | redis-server | memcached | ruby | golang' -filter-with-deps wheezy-security http://security.debian.org/ wheezy/updates main
...
&lt;/pre>
&lt;h3 id="updating-mirrors">Updating mirrors&lt;/h3>
&lt;p>Update &lt;code>wheezy-main&lt;/code> mirror for the first time:&lt;/p>
&lt;pre class="code">
$ aptly mirror update wheezy-main
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/InRelease...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/Release.gpg...
gpgv: Signature made Sat 12 Jul 2014 10:59:56 AM UTC using RSA key ID 46925553
gpgv: Good signature from "Debian Archive Automatic Signing Key (7.0/wheezy) &amp;lt;ftpmaster@debian.org&amp;gt;"
gpgv: Signature made Sat 12 Jul 2014 11:04:06 AM UTC using RSA key ID 65FFB764
gpgv: Good signature from "Wheezy Stable Release Key &amp;lt;debian-release@lists.debian.org&amp;gt;"
Downloading &amp;amp; parsing package files...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy/main/binary-amd64/Packages.bz2...
Applying filter...
Packages filtered: 35933 -> 304.
Building download queue...
Download queue: 304 items (147.18 MiB)
Downloading http://ftp.ru.debian.org/debian/pool/main/g/gnutls26/libgnutls26_2.12.20-8+deb7u2_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/e/eglibc/locales_2.13-38+deb7u2_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/p/perl/perl-modules_5.14.2-21+deb7u1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/v/vim/vim-tiny_7.3.547-7_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/libt/libtext-iconv-perl/libtext-iconv-perl_1.7-5_amd64.deb...
....
Mirror `wheezy-main` has been successfully updated.
&lt;/pre>
&lt;p>Packages files have been downloaded to &lt;code>~/.aptly/pool/&lt;/code>, current mirror contents stored in the package database.
You can update mirror at any moment as required.&lt;/p>
&lt;p>And, for two other mirrors:&lt;/p>
&lt;pre class="code">
$ aptly mirror update wheezy-security
...
$ aptly mirror update wheezy-updates
...
&lt;/pre>
&lt;h3 id="taking-snapshots">Taking snapshots&lt;/h3>
&lt;p>It&amp;rsquo;s time take snapshots of the mirrors to preserve &lt;em>exact&lt;/em> current mirror state. I will label snapshots
after mirror name, applying version for the main &lt;code>wheezy&lt;/code> mirror and current date for frequently updated
&lt;code>security&lt;/code> and &lt;code>updates&lt;/code> mirrors:&lt;/p>
&lt;pre class="code">
$ aptly snapshot create wheezy-main-7.6 from mirror wheezy-main
Snapshot wheezy-main-7.6 successfully created.
You can run 'aptly publish snapshot wheezy-main-7.6' to publish snapshot as Debian repository.
$ aptly snapshot create wheezy-updates-20141009 from mirror wheezy-updates
Snapshot wheezy-updates-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-updates-20141009' to publish snapshot as Debian repository.
$ aptly snapshot create wheezy-security-20141009 from mirror wheezy-security
Snapshot wheezy-security-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-security-20141009' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>Snapshots are created instantly and they don&amp;rsquo;t occupy any extra space: only list of packages
is stored inside the snapshot.&lt;/p>
&lt;h3 id="merging-snapshots">Merging snapshots&lt;/h3>
&lt;p>Now we can merge snapshots into one, producing &amp;ldquo;wheezy with security updates applied&amp;rdquo;:&lt;/p>
&lt;pre class="code">
$ aptly snapshot merge -latest wheezy-final-20141009 wheezy-main-7.6 wheezy-updates-20141009 wheezy-security-20141009
Snapshot wheezy-final-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-final-20141009' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>Flag &lt;code>-latest&lt;/code> chooses merge strategy: package with latest version &amp;ldquo;wins&amp;rdquo;.&lt;/p>
&lt;p>Let&amp;rsquo;s verify that merge was correct:&lt;/p>
&lt;pre class="code">
$ aptly package show -with-references 'Name (nginx)'
Package: nginx
Version: 1.2.1-2.2+wheezy2
Installed-Size: 87
Priority: optional
Section: httpd
Maintainer: Kartik Mistry &amp;lt;kartik@debian.org&amp;gt;
Architecture: all
Description: small, powerful, scalable web/proxy server
MD5sum: fa5f86939aace1957b1fc846573cd2b1
SHA1: 05e521a9ec7854ed706aabcb0c0ea83fdee980d2
SHA256: 846905a046608aded2d29e05409ec3c0024717e6446cd0bdb544396a9652644d
Tag: implemented-in::c, interface::daemon, network::server, network::service,protocol::http, role::program, use::proxying
Description-md5: 19a4ea43e33eae4a46abf8a78966deb5
Source:
Filename: nginx_1.2.1-2.2+wheezy2_all.deb
Size: 61254
Depends: nginx-full | nginx-light
Homepage: http://nginx.net
References to package:
mirror [wheezy-main]: http://ftp.ru.debian.org/debian/ wheezy
snapshot [wheezy-main-7.6]: Snapshot from mirror [wheezy-main]: http://ftp.ru.debian.org/debian/ wheezy
Package: nginx
Version: 1.2.1-2.2+wheezy3
Installed-Size: 87
Priority: optional
Section: web
Maintainer: Kartik Mistry &amp;lt;kartik@debian.org&amp;gt;
Architecture: all
Description: small, powerful, scalable web/proxy server
MD5sum: 25ae5234388762babbfbe3632dbdcc57
SHA1: 34d7ff8f24cc47960688ae84d6d98f92275ad453
SHA256: 516d33cf93f20ca070a203bafacc6f7ceb04bd3ae221d5a9a59f90e2ab828245
Depends: nginx-full | nginx-light
Description-md5: 19a4ea43e33eae4a46abf8a78966deb5
Homepage: http://nginx.net
Source:
Filename: nginx_1.2.1-2.2+wheezy3_all.deb
Size: 61374
References to package:
mirror [wheezy-security]: http://security.debian.org/ wheezy/updates
snapshot [wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'
snapshot [wheezy-security-20141009]: Snapshot from mirror [wheezy-security]: http://security.debian.org/ wheezy/updates
&lt;/pre>
&lt;p>New version of &lt;code>nginx&lt;/code> package which came from &lt;code>wheezy-security&lt;/code> mirror is now part of our final snapshot
&lt;code>wheezy-final-20141009&lt;/code>.&lt;/p>
&lt;h3 id="publishing-repository">PUBLISHING REPOSITORY&lt;/h3>
&lt;p>Final step: publishing our snapshot as Debian repository, ready to be consumed by &lt;code>apt-get&lt;/code>:&lt;/p>
&lt;pre class="code">
$ aptly publish snapshot wheezy-final-20141009
ERROR: unable to publish: unable to guess distribution name, please specify explicitly
&lt;/pre>
&lt;p>aptly complains that it can&amp;rsquo;t guess distribution name, as the source mirrors we had (main, security and
updates) all have different distribution names. So we need to help aptly a bit by supplying
distribution name:&lt;/p>
&lt;pre class="code">
$ aptly publish snapshot -distribution=wheezy wheezy-final-20141009
Loading packages...
Generating metadata files and linking package files...
Finalizing metadata files...
Signing file 'Release' with gpg, please enter your passphrase when prompted:
You need a passphrase to unlock the secret key for
user: "Andrey Smirnov (Signing repos) &amp;lt;me@smira.ru&amp;gt;"
2048-bit RSA key, ID 6430156A, created 2014-10-09
Clearsigning file 'Release' with gpg, please enter your passphrase when prompted:
You need a passphrase to unlock the secret key for
user: "Andrey Smirnov (Signing repos) &amp;lt;me@smira.ru&amp;gt;"
2048-bit RSA key, ID 6430156A, created 2014-10-09
Snapshot wheezy-final-20141009 has been successfully published.
Please setup your webserver to serve directory '/home/smira/.aptly/public' with autoindexing.
Now you can add following line to apt sources:
deb http://your-server/ wheezy main
Don't forget to add your GPG key to apt with apt-key.
You can also use `aptly serve` to publish your repositories over HTTP quickly.
&lt;/pre>
&lt;p>The repository is published to &lt;code>~/.aptly/public/&lt;/code> directory. You can start any HTTP server
to serve this directory as static files, or use aptly built-in webserver for testing:&lt;/p>
&lt;pre class="code">
$ aptly serve
Serving published repositories, recommended apt sources list:
# ./wheezy [amd64] publishes {main: [wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'}
deb http://debian:8080/ wheezy main
Starting web server at: :8080 (press Ctrl+C to quit)...
&lt;/pre>
&lt;p>I can also visalize the objects I&amp;rsquo;ve created and dependencies:&lt;/p>
&lt;pre class="code">
$ aptly graph
Loading mirrors...
Loading local repos...
Loading snapshots...
Loading published repos...
Generating graph...
Rendered to PNG file: /tmp/aptly-graph128726742.png
&lt;/pre>
&lt;p>This would result in picture like this one:&lt;/p>
&lt;img class="img-responsive" src="../../img/aptly-graph.png">
&lt;h3 id="using-repository">Using repository&lt;/h3>
&lt;p>First I need to import public part of the key that was used to sign the repository
into trusted apt keyring on target machine.&lt;/p>
&lt;p>Export the key on machine with aptly:&lt;/p>
&lt;pre class="code">
$ gpg --export --armor > my_key.pub
&lt;/pre>
&lt;p>Copy &lt;code>my_key.pub&lt;/code> to target machine and import it into apt keyring:&lt;/p>
&lt;pre class="code">
$ sudo apt-key add my_key.pub
OK
&lt;/pre>
&lt;p>It&amp;rsquo;s time to edit &lt;code>/etc/apt/sources.list&lt;/code>. I comment out default sources and add address of my
first machine running &lt;code>aptly serve&lt;/code> currently:&lt;/p>
&lt;pre>&lt;code>#deb http://ftp.ru.debian.org/debian/ wheezy main
#deb-src http://ftp.ru.debian.org/debian/ wheezy main
deb http://10.0.2.14:8080/ wheezy main
&lt;/code>&lt;/pre>
&lt;p>Repository is ready to be used:&lt;/p>
&lt;pre class="code">
$ sudo apt-get update
Get:1 http://10.0.2.14 wheezy Release.gpg [490 B]
Hit http://10.0.2.14 wheezy Release
Hit http://10.0.2.14 wheezy/main amd64 Packages
Ign http://10.0.2.14 wheezy/main Translation-en_US
Ign http://10.0.2.14 wheezy/main Translation-en
Fetched 490 B in 0s (33.1 kB/s)
Reading package lists... Done
$ sudo apt-get upgrade
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages have been kept back:
libc-bin libc6 openssh-client
The following packages will be upgraded:
apt apt-utils base-files bash dpkg gnupg gpgv krb5-locales libapt-inst1.5 libapt-pkg4.12 libgnutls26 libgssapi-krb5-2 libk5crypto3 libkrb5-3 libkrb5support0 libssl1.0.0 libxfont1 locales
multiarch-support tzdata
20 upgraded, 0 newly installed, 0 to remove and 3 not upgraded.
Need to get 19.6 MB of archives.
After this operation, 74.8 kB of additional disk space will be used.
Do you want to continue [Y/n]? y
Get:1 http://10.0.2.14/ wheezy/main base-files amd64 7.1wheezy6 [78.7 kB]
Get:2 http://10.0.2.14/ wheezy/main bash amd64 4.2+dfsg-0.1+deb7u3 [1,501 kB]
...
&lt;/pre>
&lt;p>As this repository has been published from snapshot, it would never change until it is update to new snapshot.
Good thing is that I can setup all my machine to use this repo and get identical set of packages
installed.
Bad thing is that I need to maintain and update my repo as updates are coming,
but if I have many machines, the advantage of predictable upgrades outweighs the maintenance costs.&lt;/p>
&lt;h3 id="upgrading-repository">Upgrading repository&lt;/h3>
&lt;p>Several days after, when I update my mirrors I discover new security updates:&lt;/p>
&lt;pre class="code">
$ aptly mirror update wheezy-security
....
&lt;/pre>
&lt;p>So it&amp;rsquo;s time to create new snapshot:&lt;/p>
&lt;pre class="code">
$ aptly snapshot create wheezy-security-20141019 from mirror wheezy-security
Snapshot wheezy-security-20141019 successfully created.
You can run 'aptly publish snapshot wheezy-security-20141019' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>And do merge once again:&lt;/p>
&lt;pre class="code">
$ aptly snapshot merge -latest wheezy-final-20141019 wheezy-main-7.6 wheezy-updates-20141009 wheezy-security-20141019
Snapshot wheezy-final-20141019 successfully created.
You can run 'aptly publish snapshot wheezy-final-20141019' to publish snapshot as Debian repository.
&lt;/pre>
&lt;p>Now I can update my published repository by switching it to new snapshot:&lt;/p>
&lt;pre>
$ aptly publish switch wheezy wheezy-final-20141019
Loading packages...
Generating metadata files and linking package files...
Finalizing metadata files...
...
Cleaning up prefix "." components main...
Publish for snapshot ./wheezy [amd64] publishes {main: [wheezy-final-20141019]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141019'} has been successfully switched to new snapshot.
&lt;/pre>
&lt;p>&lt;code>apt-get&lt;/code> would notice new packages on next update, and I can upgrade my target machine.&lt;/p>
&lt;p>If run &lt;code>aptly graph&lt;/code> again, the picture would be more interesting:&lt;/p>
&lt;img class="img-responsive" src="../../img/aptly-graph2.png">
&lt;h3 id="maintenance">Maintenance&lt;/h3>
&lt;p>You can drop old snapshots as they&amp;rsquo;re not used anymore. This would allow to cleanup some files
with &lt;code>aptly db cleanup&lt;/code>:&lt;/p>
&lt;pre class="code">
$ aptly db cleanup
Loading mirrors, local repos and snapshots...
Loading list of all packages...
Deleting unreferenced packages (23)...
Building list of files referenced by packages...
Building list of files in package pool...
Deleting unreferenced files (10)...
Compacting database...
&lt;/pre>
&lt;p>Package files are only deleted if no objects (snapshots, mirrors, local repositories) reference them.&lt;/p>
&lt;p>Next tutorial is about &lt;a href="http://aptly-dev.github.io/www.aptly.info/tutorial/pull/">pulling new version of packages from backports or 3rd party repos&lt;/a>.&lt;/p></description></item></channel></rss>