<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>aptly - Managing repositories of your packages</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=/favicon.ico><link type=text/css rel=stylesheet href=/css/styles.css><link rel=canonical href=https://www.aptly.info/tutorial/repo/><link href=/post/index.xml rel=alternate type=application/rss+xml title="Debian repository management tool"></head><body><header id=page-header><div class=container><nav class="navbar navbar-default navbar-static-top" role=navigation><ul class="nav navbar-nav nav-justified"><li class=active><a href=/tutorial/>tutorials</a></li><li><a href=/download/>download</a></li><li><a href=/support/>support</a></li><li><a href=/doc/overview/>documentation</a></li><li><a href=/about/>about</a></li><li><a href=/post/>blog</a></li></ul></nav><div class=row><div class="col-md-6 col-md-offset-3 text-center"><a class=brand href=/><i class=brand-logo></i>
<span class=brand-name>aptly</span></a></div></div></div></header><section class=primary-content><div class=container><h2 id=managing-repositories-of-your-packages>Managing repositories of your packages</h2><p class=lead>Goal: create repository with your own software as .deb packages,
publish it to Amazon S3, handle updates.</p><p>In this tutorial I would describe how do I manage <em>aptly</em> releases in repo.aptly.info repository using <em>aptly</em> itself.</p><h3 id=adding-packages-and-creating-snapshots>Adding packages and creating snapshots</h3><p>First, I create local repository that would hold all released versions of aptly:</p><pre class=code>
$ aptly repo create -distribution=squeeze -component=main aptly-release

Local repo [aptly-release] successfully added.
You can run 'aptly repo add aptly-release ...' to add packages to repository.
</pre><p>While creating repository I&rsquo;ve specified distribution and component names, that would be used
when I publish packages from this repository.</p><p>As new versions of aptly are released, I add new <code>.deb</code> packages by simply pointing aptly
to the directory with files:</p><pre class=code>
$ aptly repo add aptly-release debs
Loading packages...
[+] aptly_0.8_amd64 added
[+] aptly_0.8_i386 added
</pre><p>The repository holds all versions of aptly released so far:</p><pre class=code>
$ aptly repo show -with-packages aptly-release
Name: aptly-release
Comment:
Default Distribution: squeeze
Default Component: main
Number of packages: 14
Packages:
  aptly_0.4.1_amd64
  aptly_0.5_amd64
  aptly_0.5.1_amd64
  aptly_0.6_amd64
  aptly_0.7_amd64
  aptly_0.7.1_amd64
  aptly_0.8_amd64
  aptly_0.4.1_i386
  aptly_0.5_i386
  aptly_0.5.1_i386
  aptly_0.6_i386
  aptly_0.7_i386
  aptly_0.7.1_i386
  aptly_0.8_i386
</pre><p>After each major release, I create snapshot of local repository, so that I can &ldquo;get back in time&rdquo; to old
state of repository:</p><pre class=code>
$ aptly snapshot create aptly-0.8 from repo aptly-release

Snapshot aptly-0.8 successfully created.
You can run 'aptly publish snapshot aptly-0.8' to publish snapshot as Debian repository.

$ aptly snapshot list
List of snapshots:
 * [aptly-0.4.1]: Snapshot from local repo [aptly-release]
 * [aptly-0.5]: Snapshot from local repo [aptly-release]
 * [aptly-0.5.1]: Snapshot from local repo [aptly-release]
 * [aptly-0.6]: Snapshot from local repo [aptly-release]
 * [aptly-0.7]: Snapshot from local repo [aptly-release]
 * [aptly-0.7.1]: Snapshot from local repo [aptly-release]
 * [aptly-0.8]: Snapshot from local repo [aptly-release]

To get more information about snapshot, run `aptly snapshot show <name>`.
</pre><h3 id=publishing-to-amazon-s3>Publishing to Amazon S3</h3><p>I&rsquo;ve chosen to Amazon S3 to host aptly package repository, as it is the easiest way to get reliable HTTP
hosting for static files.</p><p>First, I&rsquo;ve created S3 bucket <code>repo.aptly.info</code> (name should match future domain name) using Amazon console, and
enabled website hosting. To the root of the bucket I&rsquo;ve uploaded manually file <code>index.html</code> with
some <a href=http://repo.aptly.info/>introductory notes</a>.</p><p>Next, for security reasons it&rsquo;s best to create separate user via Amazon IAM console that would do uploads
from aptly to S3. Save security credentials for the user into handy bash script <code>.aws.sh</code>:</p><pre><code>export AWS_SECRET_ACCESS_KEY=&quot;XXXXXXXXXXXXXXXXXXX&quot;
export AWS_ACCESS_KEY_ID=&quot;YYYYYYYYYYYYYYYYYYYY&quot;
</code></pre><p>And source this script in before performing any S3 operations from aptly:</p><pre class=code>
$ . .aws.sh
</pre><p>For the user created, apply custom security policy:</p><pre><code>{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;Stmt1405592139000&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;s3:DeleteObject&quot;,
        &quot;s3:GetObject&quot;,
        &quot;s3:ListBucket&quot;,
        &quot;s3:PutObject&quot;,
        &quot;s3:PutObjectAcl&quot;
      ],
      &quot;Resource&quot;: [
        &quot;arn:aws:s3:::repo.aptly.info/*&quot;, &quot;arn:aws:s3:::repo.aptly.info&quot;
      ]
    }
  ]
}
</code></pre><p>You would need to change <code>repo.aptly.info</code> to the name of your S3 bucket. This policy allows limited
number of operations only on one bucket, which should be pretty safe.</p><p>Final piece: setup your DNS name to point to S3, more information in <a href=http://docs.aws.amazon.com/AmazonS3/latest/dev/website-hosting-custom-domain-walkthrough.html>Amazon S3 docs</a>.</p><p>So the only thing left is to setup aptly to use that S3 bucket for publishing. I edit <code>~/.aptly.conf</code>:</p><pre><code>{
   &quot;architectures&quot;:[],
   ....
   &quot;S3PublishEndpoints&quot;:{
      &quot;repo.aptly.info&quot;:{
         &quot;region&quot;:&quot;us-east-1&quot;,
         &quot;bucket&quot;:&quot;repo.aptly.info&quot;,
         &quot;acl&quot;:&quot;public-read&quot;
      }
   }
}
</code></pre><p>In <code>S3PublishEndpoints</code> section I add new entry <code>repo.aptly.info</code> with bucket name, region (you choose region when creating the bucket) and <code>public-read</code> acl. By default aptly publishes files with <code>private</code> acl which doesn&rsquo;t work for me, as I&rsquo;m
creating public repo.</p><p>So now I can publish to S3 with aptly. I&rsquo;m publishing latest snapshot, <code>aptly-0.8</code>. I could have published repository <code>aptly-release</code> directly, but doing via snapshot gives more flexibility: I can rollback to previous snapshot if things go wrong
for any reason.</p><pre class=code>
$ aptly publish snapshot aptly-0.8 s3:repo.aptly.info:
...
</pre><p>aptly would upload package files to my S3 bucket, generate index files, do signing and so on. In the end <code>repo.aptly.info</code>
holds complete Debian repository structure, and I can use it in apt sources:</p><pre><code>deb http://repo.aptly.info/ squeeze main
</code></pre><p>When next of aptly would be released, I would add new package to <code>aptly-release</code> local repo, create snapshot <code>aptly-0.9</code> and
switch S3 published repository to new version with following command:</p><pre class=code>
$ aptly publish switch squeeze s3:repo.aptly.info: aptly-0.9
...
</pre><p>Published repositories are referenced by distribution name (<code>squeeze</code> in our case, taken from local repo defaults) and
prefix which includes storage engine (<code>s3:repo.aptly.info:</code>).</p></div></section><footer id=page-footer><div class=container><nav class="navbar navbar-default navbar-static-top" role=navigation><ul class="nav navbar-nav nav-justified"><li class=active><a href=/tutorial/>tutorials</a></li><li><a href=/download/>download</a></li><li><a href=/support/>support</a></li><li><a href=/doc/overview/>documentation</a></li><li><a href=/about/>about</a></li><li><a href=/post/>blog</a></li></ul></nav></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/aptly.js></script></body></html>