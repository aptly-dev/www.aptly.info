<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>aptly - Pulling new versions of packages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <link type="text/css" rel="stylesheet" href="/css/styles.css">
    <link rel="canonical" href="http://www.aptly.info/tutorial/pull">
    <link href="/post/index.xml" rel="alternate" type="application/rss+xml" title="Debian repository management tool" />
    
  </head>
  <body>
    <div id="job-promo" class="alert alert-info">
      <span class="glyphicon glyphicon-fire" aria-hidden="true"></span> <strong>Andrey Smirnov</strong> (author of aptly) is <strong>looking for a job</strong>. Go/Python, remote is preferred. <a class="alert-link" href="https://github.com/smira/">GitHub</a> <a class="alert-link" href="http://smira.ru/cv-eng.pdf">CV</a> <a href="mailto:me@smira.ru" class="alert-link">me@smira.ru</a>
    </div>
    <header id="page-header">
      <div class="container">
                <nav class="navbar navbar-default navbar-static-top" role="navigation">
          <ul class="nav navbar-nav nav-justified">
            <li class="active"><a href="/tutorial/">tutorials</a></li>
            <li ><a href="/download/">download</a></li>
            <li ><a href="/support/">support</a></li>
            <li ><a href="/doc/overview/">documentation</a></li>
            <li ><a href="/about/">about</a></li>
            <li ><a href="/post/">blog</a></li>
          </ul>
        </nav>

        <div class="row">
          <div class="col-md-6 col-md-offset-3 text-center">
            <a class="brand" href="/">
              <i class="brand-logo"></i>
              <span class="brand-name">aptly</span>
            </a>
          </div>
        </div>
      
      </div>
    </header>

    <section class="primary-content">
      <div class="container">
         

<h2 id="toc_0">Pulling new versions of packages</h2>

<p class="lead">Goal: pull new version of nginx package from backports, add aptly
package from 3rd party repository.</p>

<p>Let&rsquo;s start with mirrors created in <a href="/tutorial/mirror/">first tutorial</a>: <code>wheezy-main</code>,
<code>wheezy-updates</code> and <code>wheezy-security</code>.</p>

<h3 id="toc_1">Backporting nginx</h3>

<p>Create new mirror <code>wheezy-backports</code>:</p>

<pre class="code">
$ aptly mirror create -architectures=amd64 -filter=nginx -filter-with-deps wheezy-backports http://ftp.ru.debian.org/debian/ wheezy-backports main
...

$ aptly mirror update wheezy-backports
Downloading http://ftp.ru.debian.org/debian/dists/wheezy-backports/InRelease...
gpgv: Signature made Thu 09 Oct 2014 02:49:29 PM UTC using RSA key ID 46925553
gpgv: Good signature from "Debian Archive Automatic Signing Key (7.0/wheezy) &lt;ftpmaster@debian.org&gt;"
Downloading &amp; parsing package files...
Downloading http://ftp.ru.debian.org/debian/dists/wheezy-backports/main/binary-amd64/Packages.bz2...
Applying filter...
Packages filtered: 3290 -> 10.
Building download queue...
Download queue: 10 items (2.45 MiB)
Downloading http://ftp.ru.debian.org/debian/pool/main/l/luajit/libluajit-5.1-2_2.0.3+dfsg-3~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-full_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-extras_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-common_1.6.2-1~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/l/luajit/libluajit-5.1-common_2.0.3+dfsg-3~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-naxsi_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx-light_1.6.2-1~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/i/init-system-helpers/init-system-helpers_1.18~bpo70+1_all.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/g/geoip/libgeoip1_1.5.0-3~bpo70+1_amd64.deb...
Downloading http://ftp.ru.debian.org/debian/pool/main/n/nginx/nginx_1.6.2-1~bpo70+1_all.deb...

Mirror `wheezy-backports` has been successfully updated.
</pre>

<p>Once again, I&rsquo;ve been using filters to reduce download size, but I could&rsquo;ve create mirror without filter
covering whole wheezy-backports repostiroy.</p>

<p>Create snapshot of that mirror:</p>

<pre class="code">
$ aptly snapshot create wheezy-backports-20141009 from mirror wheezy-backports

Snapshot wheezy-backports-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-backports-20141009' to publish snapshot as Debian repository.
</pre>

<p>The magic happens when I ask aptly to pull new version of <code>nginx</code> package from <code>wheezy-backports</code> snapshot
into my <code>wheezy-main</code> snapshot:</p>

<pre class="code">
$ aptly snapshot pull wheezy-final-20141009 wheezy-backports-20141009 wheezy-main-nginx-20141009 nginx
Dependencies would be pulled into snapshot:
    [wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'
from snapshot:
    [wheezy-backports-20141009]: Snapshot from mirror [wheezy-backports]: http://ftp.ru.debian.org/debian/ wheezy-backports
and result would be saved as new snapshot wheezy-main-nginx-20141009.
Loading packages (327)...
Building indexes...
[+] init-system-helpers_1.18~bpo70+1_all added
[+] libluajit-5.1-2_2.0.3+dfsg-3~bpo70+1_amd64 added
[+] libluajit-5.1-common_2.0.3+dfsg-3~bpo70+1_all added
[-] nginx-naxsi-ui_1.2.1-2.2+wheezy3_all removed
[-] nginx_1.2.1-2.2+wheezy3_all removed
[+] nginx_1.6.2-1~bpo70+1_all added
[-] nginx-common_1.2.1-2.2+wheezy3_all removed
[+] nginx-common_1.6.2-1~bpo70+1_all added
[-] nginx-extras_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-extras_1.6.2-1~bpo70+1_amd64 added
[-] nginx-full_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-full_1.6.2-1~bpo70+1_amd64 added
[-] nginx-light_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-light_1.6.2-1~bpo70+1_amd64 added
[-] nginx-naxsi_1.2.1-2.2+wheezy3_amd64 removed
[+] nginx-naxsi_1.6.2-1~bpo70+1_amd64 added

Snapshot wheezy-main-nginx-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-main-nginx-20141009' to publish snapshot as Debian repository.
</pre>

<p>As you can see, aptly has replaced not only <code>nginx</code> package, but all its dependencies that required upgrade.
Now snapshot <code>wheezy-main-nginx-20141009</code> is Debian wheezy 7.6 plus new version of nginx.</p>

<h3 id="toc_2">Pulling aptly</h3>

<p>In order to add latest version of aptly package from <code>repo.aptly.info</code> mirror, create
and update mirror:</p>

<pre class="code">
$ aptly mirror create aptly-repo http://repo.aptly.info/ squeeze
Downloading http://repo.aptly.info/dists/squeeze/InRelease...
gpgv: Signature made Fri 03 Oct 2014 02:35:18 PM UTC using RSA key ID 2A194991
gpgv: Good signature from "Andrey Smirnov &lt;me@smira.ru&gt;"

Mirror [aptly-repo]: http://repo.aptly.info/ squeeze successfully added.
You can run 'aptly mirror update aptly-repo' to download repository contents.
$ aptly mirror update aptly-repo
Downloading http://repo.aptly.info/dists/squeeze/InRelease...
gpgv: Signature made Fri 03 Oct 2014 02:35:18 PM UTC using RSA key ID 2A194991
gpgv: Good signature from "Andrey Smirnov &lt;me@smira.ru&gt;"
Downloading &amp; parsing package files...
Downloading http://repo.aptly.info/dists/squeeze/main/binary-amd64/Packages.bz2...
Downloading http://repo.aptly.info/dists/squeeze/main/binary-i386/Packages.bz2...
Building download queue...
Download queue: 14 items (47.29 MiB)
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.6_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.6_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7.1_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.7_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.4.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.4.1_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.8_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.8_i386.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5.1_amd64.deb...
Downloading http://repo.aptly.info/pool/main/a/aptly/aptly_0.5.1_i386.deb...

Mirror `aptly-repo` has been successfully updated.
</pre>

<p>In this case I haven&rsquo;t limited architectures (so both <code>i386</code> and <code>amd64</code> were downloaded) and haven&rsquo;t specified
component name: aptly can figure it out on its own.</p>

<p>Next, create snapshot:</p>

<pre class="code">
$ aptly snapshot create aptly-0.8 from mirror aptly-repo

Snapshot aptly-0.8 successfully created.
You can run 'aptly publish snapshot aptly-0.8' to publish snapshot as Debian repository.
</pre>

<p>And pull latest version of aptly from that snapshot into my <code>wheezy-main-nginx-20141009</code> snapshot created
in previous section:</p>

<pre class="code">
$ aptly snapshot pull wheezy-main-nginx-20141009 aptly-0.8 wheezy-main-nginx-aptly-20141009 aptly
Dependencies would be pulled into snapshot:
    [wheezy-main-nginx-20141009]: Pulled into 'wheezy-main-7.6' with 'wheezy-backports-20141009' as source, pull request was: 'nginx'
from snapshot:
    [aptly-0.8]: Snapshot from mirror [aptly-repo]: http://repo.aptly.info/ squeeze
and result would be saved as new snapshot wheezy-main-nginx-aptly-20141009.
Loading packages (331)...
Building indexes...
[+] aptly_0.8_amd64 added

Snapshot wheezy-main-nginx-aptly-20141009 successfully created.
You can run 'aptly publish snapshot wheezy-main-nginx-aptly-20141009' to publish snapshot as Debian repository.
</pre>

<p>I haven&rsquo;t specified version: aptly would choose latest version by default, also aptly is smart enough
to pull only <code>amd64</code> package, as my snapshot <code>wheezy-main-nginx-20141009</code> contains only <code>amd64</code> packages.</p>

<h3 id="toc_3">Publishing</h3>

<p>So we&rsquo;re ready to publish new snapshot as Debian repository. This time I would use two prefixes: one for stable
version of repository, which is well-tested, and another one for &ldquo;testing&rdquo; version that I would like to test
on small set of machines before deploying it fully.</p>

<p>Publishing vanilla wheezy distribution from <a href="/tutorial/mirror/">mirroring tutorial</a> as stable version:</p>

<pre class="code">
$ aptly publish snapshot -distribution=wheezy wheezy-final-20141009 stable

...

Snapshot wheezy-final-20141009 has been successfully published.
Please setup your webserver to serve directory '/home/smira/.aptly/public' with autoindexing.
Now you can add following line to apt sources:
  deb http://your-server/stable/ wheezy main
Don't forget to add your GPG key to apt with apt-key.

You can also use `aptly serve` to publish your repositories over HTTP quickly.
</pre>

<p>I&rsquo;ve added one more argument on the command line, <code>stable</code> which is publishing prefix (simply
subdirectory to publish under). Now the apt-sources line suggested by aptly contains
that prefix: <code>deb http://your-server/stable/ wheezy main</code>.</p>

<p>And I publish my wheezy + new nginx + aptly repository as testing version:</p>

<pre class="code">
$ aptly publish snapshot -distribution=wheezy wheezy-main-nginx-aptly-20141009 testing

...

Snapshot wheezy-main-nginx-aptly-20141009 has been successfully published.
Please setup your webserver to serve directory '/home/smira/.aptly/public' with autoindexing.
Now you can add following line to apt sources:
  deb http://your-server/testing/ wheezy main
Don't forget to add your GPG key to apt with apt-key.

You can also use `aptly serve` to publish your repositories over HTTP quickly.
</pre>

<p>I can verify that I have two published repos in different prefixes:</p>

<pre class="code">
$ aptly serve
Serving published repositories, recommended apt sources list:

# stable/wheezy [amd64] publishes {main: [wheezy-final-20141009]: Merged from sources: 'wheezy-main-7.6', 'wheezy-updates-20141009', 'wheezy-security-20141009'}
deb http://debian:8080/stable/ wheezy main
# testing/wheezy [amd64] publishes {main: [wheezy-main-nginx-aptly-20141009]: Pulled into 'wheezy-main-nginx-20141009' with 'aptly-0.8' as source, pull request was: 'aptly'}
deb http://debian:8080/testing/ wheezy main
</pre>

<p>After successful round of testing, I can use <code>aptly publish switch</code> to switch by stable published repository
to the new snapshot <code>wheezy-main-nginx-aptly-20141009</code> and update my target machines.</p>

<p>If I generate the graph, it would look like that:</p>

<p><img class="img-responsive" src="/img/aptly-graph3.png"></p>

      </div>
    </section>
    <footer id="page-footer">
      <div class="container">
                <nav class="navbar navbar-default navbar-static-top" role="navigation">
          <ul class="nav navbar-nav nav-justified">
            <li class="active"><a href="/tutorial/">tutorials</a></li>
            <li ><a href="/download/">download</a></li>
            <li ><a href="/support/">support</a></li>
            <li ><a href="/doc/overview/">documentation</a></li>
            <li ><a href="/about/">about</a></li>
            <li ><a href="/post/">blog</a></li>
          </ul>
        </nav>

        <div class="copy">
          Sponsored by <a href="http://express42.com/">express42</a> &copy;&nbsp;2013-2014 Andrey Smirnov
        </div>
      </div>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/aptly.js"></script>
    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-6065617-2', 'aptly.info');
    ga('send', 'pageview');

    </script>
  </body>
</html>
